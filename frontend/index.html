<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOL Entry Scanner BR</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Bebas+Neue&family=DM+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#04080c;--bg2:#070d13;--surface:#0b141c;--surface2:#0e1c27;
  --border:#152233;--border2:#1e3045;
  --accent:#00d4ff;--green:#00ff87;--red:#ff3b5c;--yellow:#ffcc00;--purple:#b06fff;--orange:#ff7c40;
  --text:#ddeef8;--muted:#3d6070;--muted2:#5a7d8f;
  --mono:'IBM Plex Mono',monospace;--display:'Bebas Neue',sans-serif;--sans:'DM Sans',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,.022) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.022) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}
.glc{position:fixed;top:-180px;left:-180px;width:480px;height:480px;background:radial-gradient(circle,rgba(0,212,255,.07) 0%,transparent 70%);pointer-events:none;z-index:0;}
.glr{position:fixed;bottom:-180px;right:-180px;width:550px;height:550px;background:radial-gradient(circle,rgba(0,255,135,.05) 0%,transparent 70%);pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;max-width:1440px;margin:0 auto;padding:0 16px 70px;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:13px 0 11px;border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.logo{display:flex;align-items:center;gap:11px;}
.lhex{width:38px;height:38px;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-family:var(--display);font-size:19px;color:var(--accent);box-shadow:0 0 18px rgba(0,212,255,.35);animation:hp 3s ease-in-out infinite;flex-shrink:0;}
@keyframes hp{0%,100%{box-shadow:0 0 18px rgba(0,212,255,.3)}50%{box-shadow:0 0 34px rgba(0,212,255,.65)}}
.logo h1{font-family:var(--display);font-size:20px;letter-spacing:.08em;color:var(--accent);line-height:1;}
.logo p{font-family:var(--mono);font-size:9px;color:var(--muted2);letter-spacing:.13em;text-transform:uppercase;margin-top:2px;}
.trr{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.brlbox{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);padding:6px 12px;}
.brlbox .bl{font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted2);}
.brlbox .bv{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--yellow);}
.brlbox .bs{font-family:var(--mono);font-size:9px;color:var(--muted);}
.ctog{display:flex;border:1px solid var(--border);overflow:hidden;}
.ctog button{padding:6px 12px;font-family:var(--mono);font-size:11px;font-weight:700;border:none;cursor:pointer;text-transform:uppercase;letter-spacing:.08em;background:transparent;color:var(--muted2);transition:all .15s;}
.ctog button.active{background:var(--accent);color:#000;}
.livebadge{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:.1em;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:bl 1.1s ease-in-out infinite;}
@keyframes bl{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.7)}}
.cfg-btn{padding:6px 12px;font-family:var(--mono);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;background:transparent;border:1px solid var(--border2);color:var(--muted2);cursor:pointer;transition:all .15s;}
.cfg-btn:hover{border-color:var(--yellow);color:var(--yellow);}

/* ‚îÄ‚îÄ BANNER SETUP ‚îÄ‚îÄ */
.banner-setup{background:linear-gradient(90deg,rgba(255,204,0,.15),rgba(255,204,0,.06));border-bottom:1px solid rgba(255,204,0,.35);padding:10px 16px;}
.banner-inner{max-width:1440px;margin:0 auto;display:flex;flex-direction:column;gap:3px;}
.banner-inner span{font-family:var(--sans);font-size:13px;color:var(--yellow);}
.banner-inner small{font-family:var(--mono);font-size:10px;color:var(--muted2);}
.key-security-note{font-size:11px;color:var(--muted2);margin-top:4px;}
.loading-cell{opacity:0.5;}
.spinner-inline{display:inline-block;width:10px;height:10px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:4px;}

/* ‚îÄ‚îÄ TICKER ‚îÄ‚îÄ */
.ticker{background:var(--surface);border-bottom:1px solid var(--border);padding:7px 0;overflow:hidden;display:flex;align-items:center;margin-bottom:16px;}
.tlbl{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.14em;color:var(--accent);padding:0 11px;flex-shrink:0;border-right:1px solid var(--border);margin-right:10px;}
.tscroll{display:flex;gap:22px;animation:stk 38s linear infinite;white-space:nowrap;}
@keyframes stk{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ti{font-family:var(--mono);font-size:11px;display:flex;align-items:center;gap:6px;}
.ti .tn{color:var(--text);font-weight:700;}
.ti.up .tv{color:var(--green);}
.ti.down .tv{color:var(--red);}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px;}
.stat{background:var(--surface);border:1px solid var(--border);padding:10px 12px;position:relative;overflow:hidden;}
.stat::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.s1::after{background:var(--accent);}.s2::after{background:var(--green);}.s3::after{background:var(--red);}
.s4::after{background:var(--yellow);}.s5::after{background:var(--purple);}.s6::after{background:var(--orange);}
.slbl{font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:.13em;color:var(--muted);margin-bottom:4px;}
.sval{font-family:var(--mono);font-size:18px;font-weight:700;}
.ssub{font-family:var(--mono);font-size:9px;color:var(--muted2);margin-top:1px;}
.ca{color:var(--accent);}.cg{color:var(--green);}.cr{color:var(--red);}.cy{color:var(--yellow);}.cp{color:var(--purple);}.co{color:var(--orange);}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:13px;}
.tab{padding:9px 19px;font-family:var(--mono);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;cursor:pointer;color:var(--muted2);border:none;background:none;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .14s;display:flex;align-items:center;gap:5px;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover{color:var(--text);}
.tbadge{background:var(--red);color:#fff;border-radius:2px;font-size:9px;padding:1px 5px;font-weight:700;animation:bl 1.1s infinite;}

/* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
.ig{display:flex;flex-direction:column;gap:4px;}
.ig label{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);}
.ig input,.ig select,.iginput{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 11px;outline:none;transition:border-color .2s;width:100%;}
.ig input:focus,.ig select:focus,.iginput:focus{border-color:var(--accent);}
.ig select option,.iginput option{background:var(--surface2);}
.ig.grow{flex:1;min-width:140px;}
.btn{padding:8px 15px;border:none;font-family:var(--mono);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;cursor:pointer;transition:all .17s;white-space:nowrap;}
.bp{background:var(--accent);color:#000;}.bp:hover{background:#fff;box-shadow:0 0 20px rgba(0,212,255,.5);}
.bg{background:transparent;color:var(--accent);border:1px solid var(--accent);}.bg:hover{background:rgba(0,212,255,.08);}
.br{background:transparent;color:var(--red);border:1px solid var(--red);}.br:hover{background:var(--red);color:#fff;}
.by{background:transparent;color:var(--yellow);border:1px solid var(--yellow);}.by:hover{background:var(--yellow);color:#000;}
.bsm{padding:5px 10px;font-size:10px;}
.controls{display:flex;gap:8px;margin-bottom:11px;flex-wrap:wrap;align-items:flex-end;}
.frow{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap;align-items:center;}
.flbl{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-right:3px;}
.chip{padding:4px 10px;font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:.07em;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted2);transition:all .13s;}
.chip.active,.chip:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,.06);}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.twrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;}
thead tr{border-bottom:1px solid var(--accent);}
th{padding:8px 11px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:.11em;color:var(--accent);cursor:pointer;white-space:nowrap;user-select:none;}
th:hover{color:#fff;}
tbody tr{border-bottom:1px solid rgba(21,34,51,.7);transition:background .13s;cursor:pointer;}
tbody tr:hover{background:rgba(0,212,255,.04);}
td{padding:9px 11px;white-space:nowrap;}
.kn{font-family:var(--sans);font-size:13px;font-weight:700;}.kh{font-size:10px;color:var(--muted2);margin-top:1px;}
.cbadge{display:inline-block;padding:2px 6px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;border-radius:2px;}
.csol{background:rgba(153,69,255,.18);color:#9945ff;border:1px solid #9945ff44;}
.cbsc{background:rgba(243,186,47,.18);color:#f3ba2f;border:1px solid #f3ba2f44;}
.cbase{background:rgba(79,154,255,.18);color:#4f9aff;border:1px solid #4f9aff44;}
.ceth{background:rgba(98,126,234,.18);color:#627eea;border:1px solid #627eea44;}
.wpill{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--accent);cursor:pointer;}
.wpill:hover{text-decoration:underline;}
.pv{color:var(--green);}.pnv{color:var(--red);}
.wrw{display:flex;align-items:center;gap:6px;}
.wrbar{width:50px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.wrfill{height:100%;border-radius:2px;}
.ai{display:inline-flex;align-items:center;gap:4px;font-size:10px;}
.adot{width:7px;height:7px;border-radius:50%;}
.aon{background:var(--green);box-shadow:0 0 7px var(--green);animation:bl 1.1s infinite;}
.aoff{background:var(--border2);}
.abtn{padding:4px 10px;font-family:var(--mono);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;border:1px solid var(--green);background:transparent;color:var(--green);cursor:pointer;transition:all .13s;}
.abtn:hover{background:var(--green);color:#000;}
.empty{text-align:center;padding:45px 20px;color:var(--muted);}
.empty .ei{font-size:32px;opacity:.22;margin-bottom:9px;}
.empty p{font-family:var(--mono);font-size:11px;text-transform:uppercase;letter-spacing:.1em;}

/* ‚îÄ‚îÄ TRADES LAYOUT ‚îÄ‚îÄ */
.tlay{display:grid;grid-template-columns:1fr 390px;gap:12px;}
.tfeed{background:var(--surface);border:1px solid var(--border);}
.tfhdr{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;border-bottom:1px solid var(--border);}
.tftitle{font-family:var(--display);font-size:17px;letter-spacing:.08em;color:var(--accent);display:flex;align-items:center;gap:6px;}
.tfc{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.tfc select{padding:5px 8px;font-size:10px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);outline:none;}
#tBody{max-height:68vh;overflow-y:auto;}
.thead-t{display:grid;grid-template-columns:65px 1fr 95px 110px 110px 130px 70px;background:var(--surface2);border-bottom:1px solid var(--border2);position:sticky;top:0;z-index:2;}
.thead-t>div{padding:6px 10px;font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.11em;color:var(--accent);}
.trow{display:grid;grid-template-columns:65px 1fr 95px 110px 110px 130px 70px;border-bottom:1px solid rgba(21,34,51,.8);transition:background .12s;cursor:pointer;animation:sil .28s ease;}
@keyframes sil{from{transform:translateX(-6px);opacity:0}to{transform:translateX(0);opacity:1}}
.trow:hover{background:rgba(0,212,255,.04);}
.trow.buy-row{border-left:2px solid var(--green);}
.trow.sell-row{border-left:2px solid var(--red);}
.trow>div{padding:9px 10px;}
.tt{font-size:10px;color:var(--muted2);}
.ttn{font-family:var(--sans);font-size:13px;font-weight:700;}
.tsym{font-size:10px;color:var(--muted2);}
.tca{font-size:10px;color:var(--accent);cursor:pointer;display:flex;align-items:center;gap:3px;margin-top:1px;}
.tca:hover{text-decoration:underline;}
.ttag{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:2px 7px;}
.buy-tag{background:rgba(0,255,135,.15);color:var(--green);border:1px solid rgba(0,255,135,.25);}
.sell-tag{background:rgba(255,59,92,.15);color:var(--red);border:1px solid rgba(255,59,92,.25);}
.tmc .mcv{font-family:var(--mono);font-size:12px;font-weight:700;}
.tmc .mclbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-top:1px;}
.tkol{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:700;}
.tage{font-size:10px;color:var(--muted2);display:flex;align-items:center;}

/* ‚îÄ‚îÄ TOKEN PANEL ‚îÄ‚îÄ */
.tpanel{background:var(--surface);border:1px solid var(--border);display:flex;flex-direction:column;}
.tphdr{padding:12px 13px;border-bottom:1px solid var(--border);}
.tptitle{font-family:var(--display);font-size:15px;letter-spacing:.06em;}
.tpsub{font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-top:2px;}
.tpempty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:280px;color:var(--muted);font-family:var(--mono);font-size:11px;text-transform:uppercase;letter-spacing:.1em;text-align:center;gap:8px;}
.tpempty .ei{font-size:28px;opacity:.2;}
.tpempty.detail-empty h3{font-family:var(--display);font-size:14px;letter-spacing:.06em;color:var(--accent);margin-bottom:6px;}
.tpempty.detail-empty p,.tpempty.detail-empty small{font-size:10px;color:var(--muted2);}
.tptokhead{padding:13px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.tplogo{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;border:2px solid var(--border2);overflow:hidden;}
.tplogo img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.tptnm{font-family:var(--sans);font-size:15px;font-weight:800;}
.tptsym{font-family:var(--mono);font-size:11px;color:var(--muted2);margin-top:2px;}
.tpgrid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);}
.tps{background:var(--surface);padding:9px 12px;}
.tpslbl{font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:.13em;color:var(--muted);margin-bottom:3px;}
.tpsval{font-family:var(--mono);font-size:13px;font-weight:700;}
.tpca{padding:12px 13px;border-top:1px solid var(--border);}
.tpcalbl{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:5px;}
.tpcabox{background:var(--surface2);border:1px solid var(--border2);padding:7px 10px;display:flex;align-items:center;gap:6px;}
.tpcaaddr{font-family:var(--mono);font-size:10px;color:var(--accent);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cpbtn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:2px 3px;transition:color .12s;flex-shrink:0;}
.cpbtn:hover{color:var(--accent);}
.tplinks{display:flex;gap:6px;padding:0 13px 13px;flex-wrap:wrap;}
.tplnk{padding:5px 10px;font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:.07em;border:1px solid var(--border2);color:var(--text);background:transparent;text-decoration:none;cursor:pointer;transition:all .13s;}
.tplnk:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ AI ANALYSIS BOX ‚îÄ‚îÄ */
.ai-box{margin:0 13px 13px;border:1px solid var(--border2);background:var(--surface2);}
.ai-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;border-bottom:1px solid var(--border);}
.ai-title{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.13em;color:var(--purple);display:flex;align-items:center;gap:6px;}
.ai-body{padding:10px 11px;font-family:var(--mono);font-size:10px;line-height:1.65;color:var(--muted2);}
.ai-body.loading{display:flex;align-items:center;gap:8px;color:var(--muted);}
.ai-body.ready{color:var(--text);}
.ai-score{display:inline-block;padding:2px 8px;font-size:10px;font-weight:700;border-radius:2px;margin-left:6px;}
.ai-score.buy{background:rgba(0,255,135,.2);color:var(--green);border:1px solid rgba(0,255,135,.3);}
.ai-score.sell{background:rgba(255,59,92,.2);color:var(--red);border:1px solid rgba(255,59,92,.3);}
.ai-score.neutral{background:rgba(255,204,0,.2);color:var(--yellow);border:1px solid rgba(255,204,0,.3);}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:12px;height:12px;border:2px solid var(--border2);border-top-color:var(--purple);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.alay{display:grid;grid-template-columns:1fr 320px;gap:12px;}
.afeed{background:var(--surface);border:1px solid var(--border);}
.afhdr{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;border-bottom:1px solid var(--border);}
.aftitle{font-family:var(--display);font-size:17px;letter-spacing:.08em;color:var(--yellow);display:flex;align-items:center;gap:6px;}
.aflist{max-height:60vh;overflow-y:auto;}
.afitem{display:flex;align-items:flex-start;gap:8px;padding:9px 12px;border-bottom:1px solid rgba(21,34,51,.8);animation:sil .28s ease;}
.afdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.afbuy{background:var(--green);box-shadow:0 0 6px var(--green);}
.afsell{background:var(--red);box-shadow:0 0 6px var(--red);}
.afwatch{background:var(--yellow);box-shadow:0 0 6px var(--yellow);}
.afbody{flex:1;}
.afname{font-weight:700;font-size:12px;}
.afmsg{font-family:var(--mono);font-size:10px;color:var(--muted2);margin-top:1px;}
.aftime{font-family:var(--mono);font-size:9px;color:var(--muted);}
.noalert{padding:34px 20px;text-align:center;font-family:var(--mono);font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;}
.cfgpanel{background:var(--surface);border:1px solid var(--border);}
.cfghdr{padding:10px 13px;border-bottom:1px solid var(--border);font-family:var(--display);font-size:15px;letter-spacing:.06em;color:var(--accent);}
.cfgbody{padding:13px;display:flex;flex-direction:column;gap:10px;}
.cfgrow{display:flex;flex-direction:column;gap:4px;}
.cfglbl{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);}

/* ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.moverlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--accent);width:90%;max-width:560px;max-height:88vh;overflow-y:auto;padding:24px;position:relative;box-shadow:0 0 60px rgba(0,212,255,.18);animation:min .2s ease;}
@keyframes min{from{transform:translateY(-14px);opacity:0}to{transform:translateY(0);opacity:1}}
.mx{position:absolute;top:10px;right:12px;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;}
.mx:hover{color:var(--red);}
.mtitle{font-family:var(--display);font-size:22px;letter-spacing:.06em;color:var(--accent);margin-bottom:2px;}
.msub{font-family:var(--mono);font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:.13em;margin-bottom:18px;}
.mrow{display:flex;flex-direction:column;gap:5px;margin-bottom:13px;}
.mrow label{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);}
.mrow input{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:9px 11px;outline:none;width:100%;transition:border-color .2s;}
.mrow input:focus{border-color:var(--accent);}
.mrow input[type=password]{letter-spacing:.1em;}
.msec{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--yellow);margin:16px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.status-row{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:10px;}
.ststatus{padding:3px 8px;font-size:9px;font-weight:700;border-radius:2px;}
.st-ok{background:rgba(0,255,135,.2);color:var(--green);border:1px solid rgba(0,255,135,.3);}
.st-err{background:rgba(255,59,92,.2);color:var(--red);border:1px solid rgba(255,59,92,.3);}
.st-idle{background:rgba(90,125,143,.2);color:var(--muted2);border:1px solid var(--border);}
.mlinks{display:flex;gap:7px;flex-wrap:wrap;}
.mlbtn{padding:6px 12px;font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:.07em;border:1px solid var(--border2);color:var(--text);background:transparent;text-decoration:none;cursor:pointer;transition:all .13s;}
.mlbtn:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ MANUAL ‚îÄ‚îÄ */
.addform{background:var(--surface);border:1px solid var(--border);padding:13px;margin-bottom:11px;display:none;}
.addform.open{display:block;}
.fgrid{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:flex-end;}

/* ‚îÄ‚îÄ KOLS MODAL ‚îÄ‚îÄ */
.kmodal{background:var(--bg2);border:1px solid var(--accent);width:90%;max-width:580px;max-height:88vh;overflow-y:auto;padding:24px;position:relative;box-shadow:0 0 60px rgba(0,212,255,.18);animation:min .2s ease;}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.ms{background:var(--surface);border:1px solid var(--border);padding:9px 12px;}
.mslbl{font-family:var(--mono);font-size:8px;text-transform:uppercase;letter-spacing:.13em;color:var(--muted);margin-bottom:3px;}
.msval{font-family:var(--mono);font-size:16px;font-weight:700;}
.msec2{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--yellow);margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.kmlinks{display:flex;gap:7px;flex-wrap:wrap;}
.kLastTrades{display:flex;flex-direction:column;gap:6px;margin-top:8px;max-height:200px;overflow-y:auto;}
.kLastTrades .kt-mini{border:1px solid var(--border);border-radius:4px;padding:8px 10px;display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;cursor:pointer;}
.kLastTrades .kt-mini:hover{background:rgba(0,212,255,.06);}
.kLastTrades .kt-mini.buy{border-left:3px solid var(--green);}
.kLastTrades .kt-mini.sell{border-left:3px solid var(--red);}
.kLastTrades .kt-empty{font-family:var(--mono);font-size:11px;color:var(--muted2);padding:12px;text-align:center;}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--accent);}
.cpbtn2{background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:1px 3px;transition:color .12s;}
.cpbtn2:hover{color:var(--accent);}
.copied{color:var(--green)!important;}
.toast{position:fixed;right:18px;bottom:18px;z-index:9999;background:var(--surface2);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 12px;opacity:0;transform:translateY(8px);pointer-events:none;transition:all .18s;}
.toast.show{opacity:1;transform:translateY(0);}

@media(max-width:1100px){.tlay{grid-template-columns:1fr;}.alay{grid-template-columns:1fr;}.stats{grid-template-columns:repeat(3,1fr);}}
@media(max-width:700px){.stats{grid-template-columns:repeat(2,1fr);}.fgrid{grid-template-columns:1fr 1fr;}.topbar{flex-direction:column;align-items:flex-start;}.trow{grid-template-columns:60px 1fr 88px 90px;}.trow>div:nth-child(5),.trow>div:nth-child(6),.trow>div:nth-child(7){display:none;}.thead-t{grid-template-columns:60px 1fr 88px 90px;}.thead-t>div:nth-child(5),.thead-t>div:nth-child(6),.thead-t>div:nth-child(7){display:none;}}
</style>
</head>
<body>
<div class="glc"></div><div class="glr"></div>
<div class="wrap">

<!-- BANNER SETUP (mostrar quando Helius n√£o configurado) -->
<div id="banner-setup" class="banner-setup" style="display:none">
  <div class="banner-inner">
    <span>‚öôÔ∏è Configure sua <strong>HELIUS_API_KEY</strong> no Railway para monitorar trades em tempo real.</span>
    <small>Sem a key, as wallets s√£o exibidas mas os trades n√£o s√£o monitorados.</small>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">
    <div class="lhex">K</div>
    <div><h1>KOL ENTRY SCANNER</h1><p>KOLScan Brasil ‚Äî Powered by Helius + GPT-4o mini</p></div>
  </div>
  <div class="trr">
    <div class="brlbox"><div><div class="bl">USD / BRL</div><div class="bv" id="brlVal">R$ 5,12</div><div class="bs" id="brlTime">‚Äî</div></div></div>
    <div class="ctog"><button id="btnBRL" class="active" onclick="setCur('BRL')">R$ BRL</button><button id="btnUSD" onclick="setCur('USD')">$ USD</button></div>
    <div class="livebadge"><div class="dot" id="wsDot"></div><span id="liveLabel">CONECTANDO...</span></div>
  </div>
</div>

<!-- TICKER -->
<div class="ticker">
  <div class="tlbl">‚ö° TOP KOLs</div>
  <div class="tscroll" id="tkr"></div>
</div>

<!-- STATS -->
<div class="stats">
  <div class="stat s1"><div class="slbl">Wallets</div><div class="sval ca" id="stW">0</div></div>
  <div class="stat s2"><div class="slbl">PnL Total</div><div class="sval" id="stP">‚Äî</div><div class="ssub" id="stPs"></div></div>
  <div class="stat s3"><div class="slbl">Win Rate M√©dio</div><div class="sval" id="stWR">‚Äî</div></div>
  <div class="stat s4"><div class="slbl">Trades Detectados</div><div class="sval cy" id="stT">0</div></div>
  <div class="stat s5"><div class="slbl">Alertas</div><div class="sval cp" id="stA">0</div></div>
  <div class="stat s6"><div class="slbl">Volume 24h</div><div class="sval co" id="stV">‚Äî</div></div>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="sw('wallets',this)">üìä KOL Wallets</button>
  <button class="tab" onclick="sw('trades',this)">‚ö° Trades Ao Vivo <span class="tbadge" id="tBadge">0</span></button>
  <button class="tab" onclick="sw('alerts',this)">üîî Alertas <span id="aBadge" style="display:none;background:var(--red);color:#fff;border-radius:2px;font-size:9px;padding:1px 5px;font-weight:700">0</span></button>
</div>

<!-- ‚ïê‚ïê‚ïê WALLETS ‚ïê‚ïê‚ïê -->
<div id="tab-wallets">
  <div class="controls">
    <div class="ig grow"><label>üîç Buscar KOL / Wallet</label><input type="text" id="srch" placeholder="Nome, @handle ou endere√ßo..." oninput="renderW()"></div>
    <div class="ig"><label>Per√≠odo</label><select id="pFil" onchange="onPeriodChange()"><option value="D">Di√°rio</option><option value="W">Semanal</option><option value="M">Mensal</option></select></div>
    <button class="btn bg" onclick="forceRefreshPnL()" title="For√ßar atualiza√ß√£o de PnL">üîÑ RECARREGAR WALLETS</button>
  </div>
  <div class="frow">
    <span class="flbl">Filtro:</span>
    <button class="chip active" onclick="setF('all',this)">Todos</button>
    <button class="chip" onclick="setF('top',this)">Top 10</button>
    <button class="chip" onclick="setF('wr80',this)">WR ‚â• 80%</button>
    <button class="chip" onclick="setF('pnlpos',this)">PnL Positivo</button>
    <button class="chip" onclick="setF('alert',this)">Alerta ON</button>
  </div>
  <div class="twrap">
    <table>
      <thead><tr><th onclick="sb('rankPnl')">RANK PNL‚Üï</th><th onclick="sb('rankWinRate')">RANK WR‚Üï</th><th onclick="sb('name')">KOL‚Üï</th><th>WALLET</th><th>CHAIN</th><th onclick="sb('pnl')">PnL‚Üï</th><th onclick="sb('winRate')">WIN RATE‚Üï</th><th onclick="sb('trades')">TRADES‚Üï</th><th>VOL 24H</th><th>ALERTA</th><th>VER</th></tr></thead>
      <tbody id="wBody"></tbody>
    </table>
    <div id="emptyW" class="empty" style="display:none" hidden aria-live="polite" aria-hidden="true"><div class="ei">‚¨°</div><p>Nenhuma wallet encontrada</p></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TRADES ‚ïê‚ïê‚ïê -->
<div id="tab-trades" style="display:none">
  <div class="tlay">
    <div class="tfeed">
      <div class="tfhdr">
        <div class="tftitle"><span class="dot"></span>TRADES EM TEMPO REAL</div>
        <div class="tfc">
          <select id="ttFil" onchange="applyTFilter()"><option value="all">Compra + Venda</option><option value="buy">S√≥ Compras</option><option value="sell">S√≥ Vendas</option></select>
          <button class="btn br bsm" onclick="clearTrades()">LIMPAR</button>
        </div>
      </div>
      <div class="thead-t"><div>HORA</div><div>TOKEN</div><div>TIPO</div><div>VALOR</div><div>MARKET CAP</div><div>KOL</div><div>IDADE</div></div>
      <div id="tBody"></div>
      <div id="tEmpty" class="empty"><div class="ei">üì°</div><p>Aguardando trades dos KOLs...</p></div>
    </div>
    <!-- TOKEN DETAIL PANEL -->
    <div class="tpanel" id="tokenPanel">
      <div class="tphdr"><div class="tptitle">DETALHE DO TOKEN</div><div class="tpsub">Clique em um trade para ver</div></div>
      <div id="tokDetail"><div class="tpempty detail-empty" id="tokDetailEmpty"><div class="ei">üì°</div><h3>Aguardando trades ao vivo</h3><p>Quando um KOL comprar ou vender um token, o trade aparecer√° no feed √† esquerda.</p><p>Clique em qualquer trade para ver:</p><ul style="text-align:left;margin:8px 0;padding-left:18px;font-size:10px;color:var(--muted2)"><li>üìä Market cap, liquidez e volume</li><li>üìà Ratio compras/vendas 24h</li><li>üîó Links: Solscan, DexScreener, Rugcheck</li><li>ü§ñ An√°lise IA com bot√£o ANALISAR</li></ul><small>Configure HELIUS_API_KEY no Railway para receber trades em tempo real.</small></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ALERTS ‚ïê‚ïê‚ïê -->
<div id="tab-alerts" style="display:none">
  <div class="alay">
    <div class="afeed">
      <div class="afhdr">
        <div class="aftitle">‚ö° FEED DE ALERTAS</div>
        <div style="display:flex;gap:6px">
          <button class="btn br bsm" onclick="alerts=[];unreadAlerts=0;renderA();updateAlertBadge()">LIMPAR</button>
        </div>
      </div>
      <div class="aflist" id="aList"><div class="noalert">Nenhum alerta ‚Äî ative o rastreamento nas wallets</div></div>
    </div>
    <div class="cfgpanel">
      <div class="cfghdr">‚öôÔ∏è NOTIFICA√á√ÉO</div>
      <div class="cfgbody">
        <div class="cfgrow"><div class="cfglbl">Tipo</div><select class="iginput" id="cfgN"><option value="visual">Visual</option><option value="sound">Visual + Som</option></select></div>
        <div class="cfgrow">
          <div class="cfglbl">Prompt IA Personalizado</div>
          <textarea class="iginput" id="aiPrompt" rows="7" placeholder="Ex: priorize narrativas de entrada de curto prazo, risco de rug, liquidez e contexto do KOL"></textarea>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn bg bsm" onclick="saveAIPrompt()">SALVAR PROMPT</button>
            <button class="btn by bsm" onclick="resetAIPrompt()">RESETAR</button>
          </div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">Esse texto √© enviado junto para o GPT-4o mini no bot√£o ANALISAR.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

</div><!-- /wrap -->

<!-- ‚ïê‚ïê‚ïê KOL MODAL ‚ïê‚ïê‚ïê -->
<div class="moverlay" id="kolOverlay" onclick="closeKbg(event)">
  <div class="kmodal">
    <button class="mx" onclick="closeKol()">‚úï</button>
    <div class="mtitle" id="kTitle"></div>
    <div class="msub" id="kSub"></div>
    <div class="mgrid" id="kStats"></div>
    <div class="msec2">üîó LINKS</div>
    <div class="kmlinks" id="kLinks"></div>
    <div class="msec2">üìä √öLTIMAS 4 TRADES</div>
    <div class="kLastTrades" id="kLastTrades"></div>
    <div class="msec2">‚öôÔ∏è ALERTA DE ENTRY</div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
      <button class="btn bsm" id="kABtn" onclick="togKA()" style="padding:7px 15px;font-size:11px;border:1px solid var(--green);color:var(--green);background:transparent">ATIVAR ALERTA</button>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted)">Notificar quando esta wallet fizer um trade</span>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG - Auto-detecta ambiente (produ√ß√£o vs local)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IS_PRODUCTION = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
const API_BASE = IS_PRODUCTION ? '' : 'http://localhost:3001';
// WebSocket na mesma porta do servidor (path /ws)
const WS_URL = IS_PRODUCTION 
  ? `wss://${window.location.host}/ws`
  : 'ws://localhost:3001/ws';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let USD_BRL = 5.12;
let cur = 'BRL';
let cFilter = 'all', sKey = 'rankPnl', sDir = 1;
let alerts = [], trades = [];
let tradeCnt = 0, curKol = null;
let toastTimer = null;
let unreadAlerts = 0;
const AI_PROMPT_STORAGE_KEY = 'kolscan_ai_prompt';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KOLS (carregados da API - sem dados fict√≠cios)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let KOLS = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORMAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(usd){
  if(cur==='BRL'){const v=usd*USD_BRL;return'R$\u00a0'+v.toLocaleString('pt-BR',{maximumFractionDigits:0});}
  return'$'+usd.toLocaleString('en-US',{maximumFractionDigits:0});
}
function fmtSub(usd){
  if(cur==='BRL')return'$'+usd.toLocaleString('en-US',{maximumFractionDigits:0});
  return'R$\u00a0'+(usd*USD_BRL).toLocaleString('pt-BR',{maximumFractionDigits:0});
}
function fmtMC(usd){
  const v=cur==='BRL'?usd*USD_BRL:usd,s=cur==='BRL'?'R$':'$';
  if(v>=1e9)return s+(v/1e9).toFixed(2)+'B';
  if(v>=1e6)return s+(v/1e6).toFixed(2)+'M';
  if(v>=1e3)return s+(v/1e3).toFixed(0)+'K';
  return s+v.toFixed(0);
}
function setCur(c){
  cur=c;
  document.getElementById('btnBRL').classList.toggle('active',c==='BRL');
  document.getElementById('btnUSD').classList.toggle('active',c==='USD');
  document.getElementById('brlVal').textContent=c==='BRL'?'R$ '+USD_BRL.toFixed(2).replace('.',','):'$ 1.00';
  renderW();renderStats();renderTicker();
}
function updTime(){document.getElementById('brlTime').textContent=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});}

async function fetchBRLRate(){
  try{
    const res=await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
    const data=await res.json();
    const rate=parseFloat(data?.USDBRL?.bid||data?.USDBRL?.ask);
    if(rate && !isNaN(rate)){USD_BRL=rate;document.getElementById('brlVal').textContent='R$ '+rate.toFixed(2).replace('.',',');renderW();renderStats();renderTicker();}
  }catch(e){document.getElementById('brlVal').textContent='R$ ‚Äî';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET ‚Äî conex√£o com backend
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws = null, wsConnected = false;

function connectWS(){
  try{
    ws = new WebSocket(WS_URL);
    ws.onopen = ()=>{
      wsConnected = true;
      document.getElementById('liveLabel').textContent = 'AO VIVO';
      document.getElementById('wsDot')?.classList?.add('dot');
    };
    ws.onmessage = (ev)=>{
      try{
        const msg = JSON.parse(ev.data);
        if(msg.type === 'trade' && msg.data) handleWSTrade(msg.data);
        else if(msg.type === 'pnl_update' && msg.data) handlePnLUpdate(msg.data);
      }catch(e){}
    };
    ws.onclose = ()=>{
      wsConnected = false;
      document.getElementById('liveLabel').textContent = 'RECONECTANDO...';
      document.getElementById('wsDot')?.classList?.remove('dot');
      setTimeout(connectWS, 3000);
    };
    ws.onerror = ()=>{
      wsConnected = false;
      document.getElementById('liveLabel').textContent = 'ERRO WS';
    };
  }catch(e){
    document.getElementById('liveLabel').textContent = 'DEMO (backend offline)';
  }
}

function handleWSTrade(data){
  const tok = {
    ...data,
    valUsd: data.valUsd ?? data.valor ?? 0,
    mc: data.mc ?? data.marketCap ?? 0,
    ca: data.ca ?? data.mint,
    age: data.age ?? 'Agora',
    holders: data.holders ?? 0,
    taxB: data.taxB ?? 0,
    taxS: data.taxS ?? 0,
    renounced: data.renounced ?? null,
    liqLocked: data.liqLocked ?? null,
    aiAnalysis: data.aiAnalysis ?? null,
  };
  addTrade(tok);
}

/**
 * Handler para atualiza√ß√µes de PnL via WebSocket
 * Backend envia lista completa com rank recalculado por PnL
 */
function handlePnLUpdate(data) {
  if(!data?.kols?.length) return;
  const { kols: updatedKols, group, period } = data;
  // Evita sobrescrever vis√£o semanal/mensal com updates di√°rios de background.
  if(period && currentPeriod !== 'daily' && period !== currentPeriod) return;
  const alertOnMap = {};
  KOLS.forEach(k => { if(k.full) alertOnMap[k.full] = k.alertOn; });
  KOLS.length = 0;
  updatedKols.forEach(k => {
    KOLS.push({ ...k, alertOn: alertOnMap[k.full] ?? k.alertOn });
  });
  renderW();
  renderStats();
  renderTicker();
  console.log(`[WS] PnL atualizado: ${updatedKols.length} KOLs (${group}, ${period || 'daily'})`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEXSCREENER ‚Äî fetch real token data (via API ou direto)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchTokenData(ca, chain='solana'){
  try {
    const r = await fetch(`${API_BASE||''}/api/token/${ca}`);
    if(r.ok) {
      const d = await r.json();
      return { name: d.name, symbol: d.symbol, priceUsd: d.priceUsd, mc: d.marketCap, liq: d.liquidity, vol24: d.volume24h, buys: d.buys, sells: d.sells, change24: d.priceChange24h, change1h: d.priceChange1h, imageUrl: d.logo, pairAddr: d.pairAddress, dexId: d.dexId, url: d.url };
    }
  }catch(e){}
  try{
    const r=await fetch(`https://api.dexscreener.com/latest/dex/tokens/${ca}`);
    if(!r.ok)return null;
    const d=await r.json();
    if(!d.pairs||!d.pairs.length)return null;
    // pick the pair with highest liquidity
    const pairs=d.pairs.sort((a,b)=>(b.liquidity?.usd||0)-(a.liquidity?.usd||0));
    const p=pairs[0];
    return{
      name:p.baseToken?.name||'?',
      symbol:p.baseToken?.symbol||'?',
      priceUsd:parseFloat(p.priceUsd)||0,
      mc:p.fdv||p.marketCap||0,
      liq:p.liquidity?.usd||0,
      vol24:p.volume?.h24||0,
      buys:p.txns?.h24?.buys||0,
      sells:p.txns?.h24?.sells||0,
      change24:p.priceChange?.h24||0,
      change1h:p.priceChange?.h1||0,
      pairAddr:p.pairAddress,
      dexId:p.dexId,
      url:p.url,
      imageUrl:p.info?.imageUrl||null,
    };
  }catch(e){return null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPENAI GPT-4o mini ‚Äî AI analysis via backend
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function analyzeTokenAI(tok){
  const customPrompt = getCustomAIPrompt();
  const tokenPayload = { ca: tok.ca, name: tok.name, symbol: tok.symbol, mc: tok.mc, liquidity: tok.liq, volume24h: tok.vol24h || 0, buys: tok.buys, sells: tok.sells, change: tok.change };
  try {
    const r = await fetch(`${API_BASE||''}/api/analyze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: tokenPayload, kol: tok.kol, tradeType: tok.type, customPrompt })
    });
    if(r.ok) {
      const d = await r.json();
      if(d.veredito) return d;
      return null;
    }
  }catch(e){}
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTicker(){
  const items=KOLS.slice(0,8).map(k=>{
    const d=k.pnl>=0?'up':'down',s=k.pnl>=0?'‚ñ≤':'‚ñº';
    return`<span class="ti ${d}"><span class="tn">${k.name}</span><span class="tv">${s}\u00a0${fmt(Math.abs(k.pnl))}\u00a0(${k.winRate}%\u00a0WR)</span></span><span style="color:var(--border2)">¬∑</span>`;
  }).join('');
  document.getElementById('tkr').innerHTML=items+items;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats(){
  document.getElementById('stW').textContent=KOLS.length;
  const tp=KOLS.reduce((s,k)=>s+k.pnl,0);
  const pe=document.getElementById('stP');
  pe.textContent=(tp>=0?'+':'')+fmt(Math.abs(tp));
  pe.className='sval '+(tp>=0?'cg':'cr');
  document.getElementById('stPs').textContent=fmtSub(Math.abs(tp));
  const aw=KOLS.length?Math.round(KOLS.reduce((s,k)=>s+k.winRate,0)/KOLS.length):0;
  const we=document.getElementById('stWR');
  we.textContent=aw+'%';we.className='sval '+(aw>=75?'cg':aw>=60?'cy':'cr');
  document.getElementById('stT').textContent=tradeCnt;
  document.getElementById('stA').textContent=KOLS.filter(k=>k.alertOn).length;
  document.getElementById('stV').textContent=fmt(KOLS.reduce((s,k)=>s+k.vol24,0));
  updateAlertBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WALLETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setF(f,el){cFilter=f;document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderW();}
function sb(k){if(sKey===k)sDir*=-1;else{sKey=k;sDir=1;}renderW();}
function renderW(){
  let data=[...KOLS];
  const byPnl=[...KOLS].sort((a,b)=>(b.pnl-a.pnl)||(b.winRate-a.winRate));
  const byWr=[...KOLS].sort((a,b)=>(b.winRate-a.winRate)||(b.pnl-a.pnl));
  const rankPnlMap=new Map(byPnl.map((k,i)=>[k.id,i+1]));
  const rankWrMap=new Map(byWr.map((k,i)=>[k.id,i+1]));
  data=data.map(k=>({
    ...k,
    rankPnl:k.rankPnl||rankPnlMap.get(k.id)||999,
    rankWinRate:k.rankWinRate||rankWrMap.get(k.id)||999
  }));
  const q=(document.getElementById('srch').value||'').toLowerCase();
  if(q)data=data.filter(k=>k.name.toLowerCase().includes(q)||k.handle.toLowerCase().includes(q)||k.wallet.toLowerCase().includes(q));
  if(cFilter==='top')data=data.filter(k=>k.rankPnl<=10);
  else if(cFilter==='wr80')data=data.filter(k=>k.winRate>=80);
  else if(cFilter==='pnlpos')data=data.filter(k=>k.pnl>0);
  else if(cFilter==='alert')data=data.filter(k=>k.alertOn);
  data.sort((a,b)=>{
    const va=a[sKey],vb=b[sKey];
    if(typeof va==='string')return sDir*va.localeCompare(vb||'');
    return sDir*((Number(va)||0)-(Number(vb)||0));
  });
  const tb=document.getElementById('wBody'),em=document.getElementById('emptyW');
  if(!data.length){
    tb.innerHTML='';
    em.style.display='block';
    em.hidden=false;
    em.setAttribute('aria-hidden','false');
    return;
  }
  em.style.display='none';
  em.hidden=true;
  em.setAttribute('aria-hidden','true');
  tb.innerHTML=data.map(k=>{
    const wr=k.winRate,wrc=wr>=80?'var(--green)':wr>=65?'var(--yellow)':'var(--red)';
    const pnlCell=k.pnl===undefined&&k._pnlUpdated===undefined?'<span class="spinner-inline"></span>‚Äî':(k.pnl>=0?`<span class="pv">+${fmt(k.pnl)}</span>`:`<span class="pnv">-${fmt(Math.abs(k.pnl))}</span>`);
    const wrCell=k.winRate===undefined&&k._pnlUpdated===undefined?'<span class="spinner-inline"></span>‚Äî':`<span style="color:${wr>=80?'var(--green)':wr>=65?'var(--yellow)':'var(--red)'}">${wr}%</span>`;
    return`<tr onclick="openKol(${k.id})">
      <td style="color:var(--muted2);font-size:11px">#${k.rankPnl}</td>
      <td style="color:var(--muted2);font-size:11px">#${k.rankWinRate}</td>
      <td><div class="kn">${k.name}</div><div class="kh">${k.handle}</div></td>
      <td><div class="wpill" onclick="event.stopPropagation();cp('${k.full}',this)">${k.wallet}<button class="cpbtn2">‚éò</button></div></td>
      <td><span class="cbadge c${k.chain.toLowerCase()}">${k.chain}</span></td>
      <td>${pnlCell}<div style="font-family:var(--mono);font-size:9px;color:var(--muted)">${fmtSub(Math.abs(k.pnl||0))}</div></td>
      <td><div class="wrw"><div class="wrbar"><div class="wrfill" style="width:${(wr||0)}%;background:${wrc}"></div></div>${wrCell}</div></td>
      <td style="color:var(--muted2)">${k.trades}</td>
      <td style="color:var(--accent)">${fmt(k.vol24)}</td>
      <td onclick="event.stopPropagation()"><div class="ai"><span class="adot ${k.alertOn?'aon':'aoff'}"></span><span style="color:${k.alertOn?'var(--green)':'var(--muted)'}">${k.alertOn?'ON':'OFF'}</span></div></td>
      <td onclick="event.stopPropagation()"><button class="abtn" onclick="openKol(${k.id})">VER</button></td>
    </tr>`;
  }).join('');
  renderStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allTrades=[];
function addTrade(tok){
  allTrades.unshift(tok);if(allTrades.length>120)allTrades.pop();
  tradeCnt++;document.getElementById('tBadge').textContent=tradeCnt;
  renderTradesFiltered();
  document.getElementById('tEmpty').style.display='none';
  if(tok.kol.alertOn)pushAlert(tok.type,tok.kol.name,`${tok.type==='buy'?'COMPROU':'VENDEU'} ${tok.name} (${tok.symbol}) ‚Äî ${fmt(tok.valUsd)}`,tok);
  renderStats();
}
function applyTFilter(){renderTradesFiltered();}
function renderTradesFiltered(){
  const tf=document.getElementById('ttFil').value;
  let data=allTrades.filter(t=>(tf==='all'||tf===t.type));
  const tbody=document.getElementById('tBody');
  tbody.innerHTML='';
  data.slice(0,60).forEach(tok=>appendTRow(tok,false));
  document.getElementById('tEmpty').style.display=data.length?'none':'block';
}
function appendTRow(tok,prepend=true){
  const tbody=document.getElementById('tBody');
  const now=tok._time||new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  tok._time=now;
  const vc=tok.type==='buy'?'var(--green)':'var(--red)';
  const aiBadge = tok.aiAnalysis ? (()=>{
    const v = (typeof tok.aiAnalysis === 'object' ? tok.aiAnalysis.veredito : tok.aiAnalysis) || '';
    const s = v.toString().toUpperCase();
    const cls = s.includes('COMPRA') ? 'buy' : s.includes('EVITAR') ? 'sell' : 'neutral';
    return `<span class="ai-score ${cls}" style="font-size:9px;margin-left:4px" title="An√°lise IA">IA</span>`;
  })() : '';
  const div=document.createElement('div');
  div.className=`trow ${tok.type}-row`;
  div.innerHTML=`
    <div class="tt">${now}</div>
    <div>
      <div class="ttn">${tok.emoji||'‚óè'} ${tok.name}${aiBadge}</div>
      <div class="tsym">${tok.symbol}</div>
      <div class="tca" onclick="event.stopPropagation();cp('${tok.ca}',this)">${(tok.ca||'').slice(0,8)}...${(tok.ca||'').slice(-6)}<span style="margin-left:3px">‚éò</span></div>
    </div>
    <div style="display:flex;align-items:center"><span class="ttag ${tok.type}-tag">${tok.type==='buy'?'COMPRA':'VENDA'}</span></div>
    <div style="display:flex;align-items:center;font-family:var(--mono);font-weight:700;color:${vc}">${fmt(tok.valUsd)}</div>
    <div class="tmc"><div class="mcv">${fmtMC(tok.mc)}</div><div class="mclbl">Market Cap</div></div>
    <div class="tkol"><span class="cbadge c${(tok.kol?.chain||'SOL').toLowerCase()}">${tok.kol?.chain||'SOL'}</span>${tok.kol?.name||'?'}</div>
    <div class="tage">${tok.age}</div>`;
  div.addEventListener('click',()=>showTokDetail(tok));
  if(prepend)tbody.insertBefore(div,tbody.firstChild);
  else tbody.appendChild(div);
}
function clearTrades(){allTrades=[];document.getElementById('tBody').innerHTML='';document.getElementById('tEmpty').style.display='block';document.getElementById('tokDetail').innerHTML='<div class="tpempty detail-empty" id="tokDetailEmpty"><div class="ei">üì°</div><h3>Aguardando trades ao vivo</h3><p>Quando um KOL comprar ou vender um token, o trade aparecer√° no feed √† esquerda.</p><p>Clique em qualquer trade para ver detalhes.</p><small>Configure HELIUS_API_KEY no Railway para receber trades em tempo real.</small></div>';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOKEN DETAIL + AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showTokDetail(tok){
  const rn=tok.renounced?'<span style="color:var(--green)">‚úì RENUNCIADO</span>':'<span style="color:var(--red)">‚úó N√ÉO RENUNCIADO</span>';
  const ll=tok.liqLocked?'<span style="color:var(--green)">‚úì TRAVADA</span>':'<span style="color:var(--yellow)">‚ö† N√ÉO TRAVADA</span>';
  const rs=((tok.taxB>5?1:0)+(tok.taxS>5?1:0)+(!tok.renounced?1:0)+(!tok.liqLocked?2:0));
  const rc=rs<=1?'var(--green)':rs<=3?'var(--yellow)':'var(--red)';
  const rl=rs<=1?'BAIXO':rs<=3?'M√âDIO':'ALTO ‚ö†';
  const chg=parseFloat(tok.change)||0;
  const chgC=chg>=0?'var(--green)':'var(--red)';
  const expUrl=`https://solscan.io/token/${tok.ca}`;
  const dexUrl=`https://dexscreener.com/solana/${tok.ca}`;
  const logoHtml=tok.imageUrl
    ?`<img src="${tok.imageUrl}" alt="${tok.name}" onerror="this.parentElement.textContent='${tok.emoji||'‚óè'}'">`:tok.emoji||'‚óè';

  document.getElementById('tokDetail').innerHTML=`
    <div class="tptokhead">
      <div class="tplogo" style="background:${tok.type==='buy'?'rgba(0,255,135,.1)':'rgba(255,59,92,.1)'}">${logoHtml}</div>
      <div>
        <div class="tptnm">${tok.name}</div>
        <div class="tptsym">${tok.symbol} ¬∑ ${tok.desc||'Token'}</div>
        <span class="cbadge csol" style="margin-top:4px;display:inline-block">SOL</span>
      </div>
    </div>
    <div class="tpgrid">
      <div class="tps"><div class="tpslbl">Market Cap</div><div class="tpsval ca">${fmtMC(tok.mc)}</div></div>
      <div class="tps"><div class="tpslbl">Liquidez</div><div class="tpsval cy">${fmtMC(tok.liq)}</div></div>
      <div class="tps"><div class="tpslbl">Holders</div><div class="tpsval">${tok.holders.toLocaleString('pt-BR')}</div></div>
      <div class="tps"><div class="tpslbl">Idade</div><div class="tpsval" style="color:var(--muted2)">${tok.age}</div></div>
      <div class="tps"><div class="tpslbl">Compras 24h</div><div class="tpsval cg">${tok.buys}</div></div>
      <div class="tps"><div class="tpslbl">Vendas 24h</div><div class="tpsval cr">${tok.sells}</div></div>
      <div class="tps"><div class="tpslbl">Tax Compra</div><div class="tpsval" style="color:${tok.taxB<=3?'var(--green)':'var(--red)'}">${tok.taxB}%</div></div>
      <div class="tps"><div class="tpslbl">Tax Venda</div><div class="tpsval" style="color:${tok.taxS<=3?'var(--green)':'var(--red)'}">${tok.taxS}%</div></div>
      <div class="tps"><div class="tpslbl">Volume 24h</div><div class="tpsval cp">${fmtMC(tok.vol24h||0)}</div></div>
      <div class="tps"><div class="tpslbl">Varia√ß√£o 24h</div><div class="tpsval" style="color:${chgC}">${chg>=0?'+':''}${chg}%</div></div>
    </div>
    <div class="tpgrid" style="margin-top:1px">
      <div class="tps"><div class="tpslbl">Ownership</div><div class="tpsval" style="font-size:11px">${rn}</div></div>
      <div class="tps"><div class="tpslbl">Liquidez</div><div class="tpsval" style="font-size:11px">${ll}</div></div>
      <div class="tps" style="grid-column:1/-1"><div class="tpslbl">Score de Risco</div><div class="tpsval" style="color:${rc}">${rl} (${rs}/5)</div></div>
    </div>
    <div class="tpca">
      <div class="tpcalbl">Contrato (CA)</div>
      <div class="tpcabox"><div class="tpcaaddr" title="${tok.ca}">${tok.ca}</div><button class="cpbtn" onclick="cp('${tok.ca}',this)">‚éò</button></div>
    </div>
    <div class="tplinks">
      <a class="tplnk" href="${expUrl}" target="_blank">üîç EXPLORER</a>
      <a class="tplnk" href="${dexUrl}" target="_blank">üìä DEXSCREENER</a>
      <a class="tplnk" href="https://rugcheck.xyz/" target="_blank">üõ° RUGCHECK</a>
      <a class="tplnk" href="https://birdeye.so/token/${tok.ca}" target="_blank">ü¶Ö BIRDEYE</a>
    </div>
    <div style="padding:0 13px;margin-bottom:6px">
      <div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--yellow);margin-bottom:6px;padding-bottom:5px;border-bottom:1px solid var(--border)">‚ö° KOL QUE OPEROU</div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:11px"><span style="font-weight:700">${tok.kol.name}</span><span style="color:${tok.type==='buy'?'var(--green)':'var(--red)'}">${tok.type==='buy'?'COMPROU':'VENDEU'} ${fmt(tok.valUsd)}</span></div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:11px"><span style="color:var(--muted2)">Win Rate</span><span style="color:var(--accent)">${tok.kol.winRate}%</span></div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;font-family:var(--mono);font-size:11px"><span style="color:var(--muted2)">Ranking</span><span style="color:var(--accent)">#${tok.kol.rank}</span></div>
    </div>
    <div class="ai-box" id="aiBox">
      <div class="ai-hdr">
        <div class="ai-title">ü§ñ AN√ÅLISE GPT-4o mini</div>
        <button class="btn by bsm" onclick="runAI()" id="aiBtn">${tok.aiAnalysis?'RE-ANALISAR':'ANALISAR'}</button>
      </div>
      <div class="ai-body" id="aiBody">${formatAIBody(tok.aiAnalysis) || 'Clique em ANALISAR para gerar an√°lise com IA'}</div>
    </div>`;

  // store current token for AI analysis
  window._currentTok=tok;

  enrichFromDex(tok);
}

async function enrichFromDex(tok){
  const data=await fetchTokenData(tok.ca,'solana');
  if(!data)return;
  // update displayed values with real data
  const fields={
    'Market Cap':fmtMC(data.mc||tok.mc),
    'Liquidez':fmtMC(data.liq||tok.liq),
    'Volume 24h':fmtMC(data.vol24||tok.vol24h||0),
  };
  // re-render just numeric cells
  const cells=document.querySelectorAll('.tpsval');
  // update change
  const chg=data.change24||parseFloat(tok.change)||0;
  tok.change=chg.toFixed(1);
}

function formatAIBody(ai){
  if(!ai) return null;
  if(typeof ai === 'string') return ai.replace(/\n/g,'<br>');
  const v = (ai.veredito || 'NEUTRO').toUpperCase();
  const cls = v.includes('COMPRA') ? 'buy' : v.includes('EVITAR') ? 'sell' : 'neutral';
  let html = `<span class="ai-score ${cls}">${v}</span> (confian√ßa: ${ai.confianca || 5}/10)<br><br>${(ai.resumo||'').replace(/\n/g,'<br>')}`;
  if(ai.pontos_positivos?.length) html += `<br><strong>Pontos positivos:</strong> ${ai.pontos_positivos.join(', ')}`;
  if(ai.riscos?.length) html += `<br><strong>Riscos:</strong> ${ai.riscos.join(', ')}`;
  return html;
}

async function runAI(){
  const tok=window._currentTok;if(!tok)return;
  const btn=document.getElementById('aiBtn');
  const body=document.getElementById('aiBody');
  if(!btn||!body)return;
  btn.disabled=true;btn.textContent='ANALISANDO...';
  body.className='ai-body loading';
  body.innerHTML='<div class="spinner"></div><span>GPT-4o mini analisando o token...</span>';
  const result=await analyzeTokenAI(tok);
  btn.disabled=false;btn.textContent='RE-ANALISAR';
  if(!result){body.className='ai-body';body.textContent='Erro ao analisar. Tente novamente.';return;}
  body.className='ai-body ready';
  if(typeof result === 'object') {
    body.innerHTML=formatAIBody(result);
    tok.aiAnalysis=result;
  } else {
    const upper=result.toString().toUpperCase();
    let scoreClass='neutral',scoreLabel='NEUTRO';
    if(upper.includes('COMPRA')||upper.includes('BUY')||upper.includes('POSITIV')){scoreClass='buy';scoreLabel='‚úì COMPRA';}
    else if(upper.includes('EVITAR')||upper.includes('AVOID')||upper.includes('SELL')||upper.includes('RUG')){scoreClass='sell';scoreLabel='‚úó EVITAR';}
    body.innerHTML=`<span class="ai-score ${scoreClass}">${scoreLabel}</span><br><br>${result.replace(/\n/g,'<br>')}`;
    tok.aiAnalysis=result;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pushAlert(type,name,msg){
  const t=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  alerts.unshift({type,name,msg,t});if(alerts.length>50)alerts.pop();
  unreadAlerts++;
  renderA();updateAlertBadge();beep(type);
}
function renderA(){
  const el=document.getElementById('aList');
  if(!alerts.length){el.innerHTML='<div class="noalert">Nenhum alerta ‚Äî ative o rastreamento nas wallets</div>';return;}
  el.innerHTML=alerts.map(a=>`<div class="afitem"><div class="afdot af${a.type}"></div><div class="afbody"><div class="afname">${a.name}</div><div class="afmsg">${a.msg}</div></div><div class="aftime">${a.t}</div></div>`).join('');
}
function updateAlertBadge(){
  const badge=document.getElementById('aBadge');
  const activeTracked=KOLS.filter(k=>k.alertOn).length;
  const shouldShow=activeTracked>0 && unreadAlerts>0;
  badge.style.display=shouldShow?'inline':'none';
  badge.textContent=unreadAlerts>9?'9+':unreadAlerts;
}
function beep(type){try{if(document.getElementById('cfgN').value!=='sound')return;const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=type==='buy'?900:type==='sell'?440:660;o.type='sine';g.gain.setValueAtTime(.12,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.35);o.start();o.stop(c.currentTime+.35);}catch(e){}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KOL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openKol(id){
  const k=KOLS.find(kol=>kol.id===id);if(!k)return;curKol=k;
  document.getElementById('kTitle').textContent=k.name;
  document.getElementById('kSub').textContent=k.handle+' ¬∑ Solana';
  document.getElementById('kStats').innerHTML=[
    {l:'PnL Total',v:(k.pnl>=0?'+':'')+fmt(Math.abs(k.pnl)),c:k.pnl>=0?'var(--green)':'var(--red)'},
    {l:'PnL ('+( cur==='BRL'?'USD':'BRL')+')',v:fmtSub(Math.abs(k.pnl)),c:'var(--muted2)'},
    {l:'Win Rate',v:k.winRate+'%',c:k.winRate>=75?'var(--green)':'var(--yellow)'},
    {l:'Trades',v:k.trades,c:'var(--text)'},
    {l:'Volume 24h',v:fmt(k.vol24),c:'var(--accent)'},
    {l:'Ranking',v:'#'+k.rank,c:'var(--accent)'},
  ].map(s=>`<div class="ms"><div class="mslbl">${s.l}</div><div class="msval" style="color:${s.c}">${s.v}</div></div>`).join('');
  document.getElementById('kLinks').innerHTML=`
    <a class="mlbtn" href="https://solscan.io/account/${k.full}" target="_blank">üîç EXPLORER</a>
    <a class="mlbtn" href="https://x.com/${k.handle.replace('@','')}" target="_blank">üê¶ TWITTER/X</a>
    <button class="mlbtn" onclick="cp('${k.full}',this)">‚éò COPIAR WALLET</button>
    <a class="mlbtn" href="https://kolscanbrasil.io/" target="_blank">üìä KOLSCAN BR</a>`;
  const lastTrades=allTrades.filter(t=>t.kol?.full===k.full).slice(0,4);
  const kLastEl=document.getElementById('kLastTrades');
  if(!lastTrades.length){kLastEl.innerHTML='<div class="kt-empty">Nenhum trade recente</div>';}
  else{kLastEl.innerHTML=lastTrades.map(t=>`<div class="kt-mini ${t.type}"><span class="ttag ${t.type}-tag" style="font-size:9px">${t.type==='buy'?'COMPRA':'VENDA'}</span><div><div style="font-weight:700;font-size:11px">${t.name||'?'} (${t.symbol||'?'})</div><div style="font-size:10px;color:var(--muted2)">${fmt(t.valUsd||0)}</div></div><div style="font-size:9px;color:var(--muted)">${t._time||'‚Äî'}</div></div>`).join('');kLastEl.querySelectorAll('.kt-mini').forEach((el,i)=>{el.onclick=()=>{closeKol();showTokDetail(lastTrades[i]);};});}
  const ab=document.getElementById('kABtn');
  ab.textContent=k.alertOn?'DESATIVAR ALERTA':'ATIVAR ALERTA';
  ab.style.borderColor=k.alertOn?'var(--red)':'var(--green)';ab.style.color=k.alertOn?'var(--red)':'var(--green)';
  document.getElementById('kolOverlay').classList.add('open');
}
function togKA(){
  if(!curKol)return;
  curKol.alertOn=!curKol.alertOn;
  const ab=document.getElementById('kABtn');
  ab.textContent=curKol.alertOn?'DESATIVAR ALERTA':'ATIVAR ALERTA';
  ab.style.borderColor=curKol.alertOn?'var(--red)':'var(--green)';
  ab.style.color=curKol.alertOn?'var(--red)':'var(--green)';
  if(curKol.alertOn)pushAlert('watch',curKol.name,'Monitoramento ativado para esta wallet');
  renderW();
  renderStats();
  updateAlertBadge();
}
function closeKbg(e){if(e.target===document.getElementById('kolOverlay'))closeKol();}
function closeKol(){document.getElementById('kolOverlay').classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sw(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  ['wallets','trades','alerts'].forEach(t=>document.getElementById('tab-'+t).style.display='none');
  document.getElementById('tab-'+tab).style.display='block';
  if(tab==='alerts'){unreadAlerts=0;updateAlertBadge();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cp(addr,el){
  navigator.clipboard.writeText(addr).then(()=>{
    showToast('Wallet copiada');
  }).catch(()=>{
    showToast('Falha ao copiar');
  });
  const orig=el.innerHTML||el.textContent;
  if(el.tagName==='BUTTON'){el.textContent='‚úì';setTimeout(()=>{try{el.innerHTML=orig;}catch(e){}},1300);}
  else{
    const icon=el.querySelector('.cpbtn2');
    if(icon){
      const prev=icon.textContent;
      icon.textContent='‚úì';
      el.classList.add('copied');
      setTimeout(()=>{icon.textContent=prev;el.classList.remove('copied');},1300);
    }else{
      el.style.color='var(--green)';
      setTimeout(()=>el.style.color='',1300);
    }
  }
}
function showToast(msg){
  const toast=document.getElementById('toast');
  if(!toast)return;
  toast.textContent=msg;
  toast.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove('show'),1400);
}

function getCustomAIPrompt(){
  return (localStorage.getItem(AI_PROMPT_STORAGE_KEY) || '').trim();
}
function saveAIPrompt(){
  const input=document.getElementById('aiPrompt');
  if(!input)return;
  const value=(input.value||'').trim();
  localStorage.setItem(AI_PROMPT_STORAGE_KEY,value);
  showToast(value?'Prompt IA salvo':'Prompt IA vazio');
}
function resetAIPrompt(){
  localStorage.removeItem(AI_PROMPT_STORAGE_KEY);
  const input=document.getElementById('aiPrompt');
  if(input)input.value='';
  showToast('Prompt IA resetado');
}
function loadAIPrompt(){
  const input=document.getElementById('aiPrompt');
  if(!input)return;
  input.value=getCustomAIPrompt();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PnL POR PER√çODO - Sistema Otimizado
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentPeriod = 'daily';
let pnlLoading = false;

/**
 * Carrega KOLs com PnL do per√≠odo selecionado
 * Para Semanal/Mensal: for√ßa refresh primeiro (backend s√≥ tem di√°rio em background)
 */
async function loadKolsWithPnL(period = 'daily') {
  if(pnlLoading) return;
  const periodMap = { D: 'daily', W: 'weekly', M: 'monthly' };
  currentPeriod = periodMap[period] || period;
  pnlLoading = true;
  try {
    if(currentPeriod !== 'daily') {
      await fetch(`${API_BASE}/api/kols/refresh-pnl`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ period: currentPeriod })
      });
    }
    const r = await fetch(`${API_BASE}/api/kols/pnl?period=${currentPeriod}`);
    if(r.ok) {
      const data = await r.json();
      if(data?.kols?.length) {
        const alertOnMap = {};
        KOLS.forEach(k => { if(k.full) alertOnMap[k.full] = k.alertOn; });
        KOLS.length = 0;
        data.kols.forEach(k => {
          KOLS.push({ ...k, alertOn: alertOnMap[k.full] ?? k.alertOn });
        });
        console.log(`[PnL] Atualizado para per√≠odo: ${currentPeriod}, rank por PnL e Win Rate`);
      }
    }
  } catch(e) { console.warn('[PnL] Erro ao carregar:', e.message); }
  pnlLoading = false;
  renderW();
  renderStats();
  renderTicker();
}

/**
 * Handler para mudan√ßa de per√≠odo
 */
function onPeriodChange() {
  const period = document.getElementById('pFil').value;
  loadKolsWithPnL(period);
}

/**
 * For√ßa atualiza√ß√£o de PnL (bot√£o manual)
 */
async function forceRefreshPnL() {
  const btn = event?.target;
  if(btn) { btn.disabled = true; btn.textContent = 'ATUALIZANDO...'; }
  
  try {
    const period = document.getElementById('pFil').value;
    const periodMap = { D: 'daily', W: 'weekly', M: 'monthly' };
    const r = await fetch(`${API_BASE}/api/kols/refresh-pnl`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ period: periodMap[period] || 'daily' })
    });
    
    if(r.ok) {
      await loadKolsWithPnL(period);
      console.log('[PnL] For√ßado refresh completo');
    }
  } catch(e) {
    console.warn('[PnL] Erro no refresh:', e.message);
  }
  
  if(btn) { btn.disabled = false; btn.textContent = 'üîÑ RECARREGAR WALLETS'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updTime(); setInterval(updTime, 30000);
fetchBRLRate(); setInterval(fetchBRLRate, 5*60*1000);

(async function init(){
  console.log('[init] Iniciando... IS_PRODUCTION:', IS_PRODUCTION);
  console.log('[init] API_BASE:', API_BASE || '(mesmo dom√≠nio)');
  console.log('[init] WS_URL:', WS_URL);
  
  // Verificar status da API (Helius configurado?)
  let apiStatus = { helius: false, openai: false, kols: 0 };
  try {
    const statusRes = await fetch(`${API_BASE}/api/status`);
    if(statusRes.ok) apiStatus = await statusRes.json();
  } catch(e) { console.warn('[init] Erro ao buscar /api/status:', e.message); }
  
  if(!apiStatus.helius) {
    document.getElementById('banner-setup').style.display = 'block';
  }
  
  // Carregar KOLs
  let loaded = false;
  
  // Tentar endpoint com PnL primeiro
  try {
    console.log('[init] Buscando /api/kols/pnl...');
    const r = await fetch(`${API_BASE}/api/kols/pnl?period=daily`);
    console.log('[init] Resposta:', r.status, r.statusText);
    if(r.ok) { 
      const data = await r.json(); 
      console.log('[init] Dados recebidos:', data);
      if(data?.kols?.length) {
        KOLS = data.kols;
        loaded = true;
        console.log('[init] Carregados', KOLS.length, 'KOLs via /api/kols/pnl');
      } else if(Array.isArray(data) && data.length) {
        // Caso a API retorne array direto
        KOLS = data;
        loaded = true;
        console.log('[init] Carregados', KOLS.length, 'KOLs (array direto)');
      }
    }
  } catch(e) {
    console.warn('[init] Erro em /api/kols/pnl:', e.message);
  }
  
  // Fallback: endpoint simples
  if(!loaded) {
    try {
      console.log('[init] Fallback: buscando /api/kols...');
      const r = await fetch(`${API_BASE}/api/kols`);
      console.log('[init] Resposta fallback:', r.status);
      if(r.ok) { 
        const data = await r.json(); 
        if(Array.isArray(data) && data.length) {
          KOLS = data;
          loaded = true;
          console.log('[init] Carregados', KOLS.length, 'KOLs via /api/kols');
        }
      }
    } catch(e2) {
      console.warn('[init] Erro em /api/kols:', e2.message);
    }
  }
  
  if(!loaded) {
    console.error('[init] FALHA: Nenhum KOL carregado!');
    document.getElementById('liveLabel').textContent = 'ERRO API';
  } else {
    console.log('[init] SUCESSO:', KOLS.length, 'KOLs carregados');
  }
  
  const searchInput=document.getElementById('srch');
  if(searchInput && typeof searchInput.value!=='string')searchInput.value='';
  loadAIPrompt();

  renderTicker(); renderW(); renderStats(); renderA(); updateAlertBadge();
  connectWS();
  setTimeout(()=>{ 
    const liveEl = document.getElementById('liveLabel');
    if(!wsConnected) {
      if(!loaded) liveEl.textContent = 'ERRO API';
      else if(!apiStatus.helius) liveEl.textContent = '‚ö†Ô∏è API KEY NECESS√ÅRIA';
      else liveEl.textContent = IS_PRODUCTION ? 'API ATIVA' : 'DEMO';
    }
  }, 4000);
})();
</script>
</body>
</html>
